
<!-- templates/register.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Sign Up</title>
    <style>
        body {
            background: #e3f2fd;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 400px;
            margin: 60px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 26px;
            font-weight: bold;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
        input {
            width: 95%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            margin-top: 25px;
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        .login-link {
            text-align: center;
            margin-top: 15px;
        }
        .login-link a {
            color: #007BFF;
            text-decoration: none;
            font-weight: bold;
        }
        /* Toast styles */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            display: none;
            z-index: 9999;
            font-size: 15px;
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
            transition: transform .28s cubic-bezier(.2,.8,.2,1), opacity .28s linear;
            opacity: 0;
            letter-spacing: 0.2px;
        }
        .toast.show { display: block; transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: linear-gradient(90deg,#2e7d32,#81c784); color:#05290f; }
        .toast.danger { background: linear-gradient(90deg,#c62828,#ef9a9a); color:#3b0000; }
        .toast.warning { background: linear-gradient(90deg,#ffb300,#ffd54f); color:#4b2f00; }
        .toast.info { background: linear-gradient(90deg,#1976d2,#64b5f6); color:#012945; }
        @keyframes pulse {
            0% { box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
            50% { box-shadow: 0 10px 26px rgba(0,0,0,0.32); }
            100% { box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
        }
        .toast.pulse { animation: pulse 1.6s ease-in-out infinite; }
    </style>
</head>
<body>
    <!-- server flash messages are injected as JSON below for the client to read -->

    <div class="container">
        <h2>Create Account</h2>
        <form method="POST">
            <label>Full Name</label>
            <input type="text" name="full_name" required>

            <label>Email Address</label>
            <input type="email" name="email" required>

            <label>Username</label>
            <input id="username" type="text" name="username" required>
            <div id="username-help" style="font-size:12px;color:#444;margin-top:6px;">
                Tip: Choose a username 8–12 characters long. Use letters, numbers or underscores.
            </div>

            <label>Password</label>
            <input id="password" type="password" name="password" autocomplete="new-password" oncut="return false" onpaste="return false" oncontextmenu="return false" required>

            <div id="pwd-meta" style="text-align:left;margin:8px 0 12px;">
                <div id="pwd-strength" aria-hidden="true" style="height:8px;background:#eee;border-radius:6px;margin-top:8px;overflow:hidden">
                    <div id="pwd-bar" style="height:100%;width:0%;background:#ff6b6b;transition:width .2s"></div>
                </div>
                <div id="pwd-recommendation" style="font-size:12px;color:#444;margin-top:8px;">
                    Tips: Use at least 8 characters, mix uppercase, lowercase, numbers and symbols.
                </div>
            </div>

            <label>Confirm Password</label>
            <input id="confirm_password" type="password" name="confirm_password" autocomplete="new-password" oncut="return false" onpaste="return false" oncontextmenu="return false" required>

            <button type="submit">Sign Up</button>
        </form>
        <div class="login-link">
            Already have an account? <a href="{{ url_for('login') }}">Log In</a>
        </div>
    </div>
</body>
<div id="copy-toast" class="toast" aria-live="polite" role="status"></div>

<!-- Server-rendered flashed messages (JSON). Provided by the register view as server_messages_json -->
<script id="server-messages" type="application/json">{{ server_messages_json | safe }}</script>

<script>
// Password strength and recommendations for registration form
;(function(){
    const pwd = document.getElementById('password');
    const confirm = document.getElementById('confirm_password');
    const bar = document.getElementById('pwd-bar');
    const rec = document.getElementById('pwd-recommendation');
    const toast = document.getElementById('copy-toast');
    const usernameInput = document.getElementById('username');
    const usernameHelp = document.getElementById('username-help');

    function scorePassword(s){
        let score = 0;
        if(!s) return 0;
        if(s.length >= 8) score += 1;
        if(/[a-z]/.test(s) && /[A-Z]/.test(s)) score += 1;
        if(/\d/.test(s)) score += 1;
        if(/[^A-Za-z0-9]/.test(s)) score += 1;
        if(s.length >= 12) score += 1;
        return score; // 0..5
    }

    function update(){
        const v = pwd.value || '';
        const s = scorePassword(v);
        const pct = (s/5)*100;
        bar.style.width = pct + '%';
        if(pct < 40) bar.style.background = '#ff6b6b';
        else if(pct < 70) bar.style.background = '#ffb86b';
        else bar.style.background = '#4caf50';

        const tips = [];
        if(v.length < 8) tips.push('at least 8 characters');
        if(!/[A-Z]/.test(v)) tips.push('an uppercase letter');
        if(!/[a-z]/.test(v)) tips.push('a lowercase letter');
        if(!/\d/.test(v)) tips.push('a number');
        if(!/[^A-Za-z0-9]/.test(v)) tips.push('a symbol (e.g. !@#$)');

        if(v.length === 0){
            rec.textContent = 'Tips: Use at least 8 characters, mix uppercase, lowercase, numbers and symbols.';
        } else if(tips.length === 0){
            rec.textContent = 'Good password — looks strong.';
        } else {
            rec.textContent = 'Consider adding: ' + tips.slice(0,3).join(', ');
        }
    }

    function showToast(msg, category){
        if(!toast) return;
        category = category || 'info';
        // set classes
        toast.className = 'toast ' + (category in {success:1,danger:1,warning:1,info:1} ? category : 'info') + ' pulse';
        toast.textContent = msg;
        // show
        toast.classList.add('show');
        // clear previous timer
        clearTimeout(showToast._t);
        // keep toast visible longer for errors
        const duration = (category === 'danger' || category === 'warning') ? 4200 : 2600;
        showToast._t = setTimeout(()=>{
            toast.classList.remove('show');
            // remove pulse after hide
            setTimeout(()=> toast.classList.remove('pulse'), 300);
        }, duration);
    }

    // --- server-side flashed messages (rendered by server into JSON) ---
    // Read JSON from the <script id="server-messages"> tag injected by the view
    let serverMessages = [];
    try{
        const el = document.getElementById('server-messages');
        if(el && el.textContent){
            const raw = JSON.parse(el.textContent || '[]');
            serverMessages = Array.isArray(raw) ? raw.map(function(m){ return { category: m[0], text: m[1] }; }) : [];
        }
    }catch(err){ serverMessages = []; }

    // show server messages as toasts on load (errors/success)
    if (serverMessages && serverMessages.length) {
        serverMessages.forEach(function(m, i){ setTimeout(function(){ showToast(m.text, m.category); }, i * 700); });
    }

    function blockClipboardAndMenu(el){
        if(!el) return;

        // show a toast when user attempts to copy
        el.addEventListener('copy', function(e){
            e.preventDefault();
            showToast('Copying password is not allowed', 'warning');
        });

        // silently block other clipboard/context interactions (allow selection so keyboard copy can be intercepted)
        ['cut','paste','contextmenu'].forEach(evt => {
            el.addEventListener(evt, function(e){ e.preventDefault(); });
        });
    }

    pwd.addEventListener('input', update);
    update();

    // Prevent copying/cutting/pasting/selection/context menu on password fields
    blockClipboardAndMenu(pwd);
    blockClipboardAndMenu(confirm);

    // Also listen at document level to reliably catch keyboard copy (Cmd/Ctrl+C)
    document.addEventListener('copy', function(e){
        const active = document.activeElement;
        if(active === pwd || active === confirm){
            e.preventDefault();
            showToast('Copying password is not allowed', 'warning');
        }
    }, true);
    // additionally catch Cmd/Ctrl+C via keydown (some browsers may not fire copy when selection is empty)
    document.addEventListener('keydown', function(e){
        const key = e.key || e.code || '';
        const isCopy = (key.toLowerCase() === 'c' || key === 'KeyC') && (e.ctrlKey || e.metaKey);
        const active = document.activeElement;
        if(isCopy && (active === pwd || active === confirm)){
            e.preventDefault();
            showToast('Copying password is not allowed', 'warning');
        }
    }, true);

    // -------- Username availability check (debounced fetch) --------
    function debounce(fn, delay){
        let t;
        return function(...args){
            clearTimeout(t);
            t = setTimeout(()=> fn.apply(this, args), delay);
        };
    }

    async function checkUsername(username){
        if(!username){
            usernameHelp.textContent = 'Tip: Choose a username 8–12 characters long. Use letters, numbers or underscores.';
            usernameHelp.style.color = '#444';
            return;
        }
        try{
            const res = await fetch(`/check_username?username=${encodeURIComponent(username)}`);
            if(!res.ok) throw new Error('Network');
            const j = await res.json();
            usernameHelp.textContent = j.message;
            usernameHelp.style.color = j.available ? '#2e7d32' : '#c62828';
        }catch(err){
            usernameHelp.textContent = 'Could not verify username availability';
            usernameHelp.style.color = '#c62828';
        }
    }

    if(usernameInput && usernameHelp){
        const debounced = debounce((e)=> checkUsername(e.target.value.trim()), 400);
        usernameInput.addEventListener('input', debounced);
        usernameInput.addEventListener('blur', (e)=> checkUsername(e.target.value.trim()));
    }
})();
</script>
</html>
